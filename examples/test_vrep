#!/usr/bin/env python

import sys
import argparse
import time

try:
    from pygesture import config
except ImportError:
    sys.path.insert(0, '..')
    from pygesture import config

from pygesture import control
from pygesture.simulation import vrepsim

parser = argparse.ArgumentParser(
    description="Runs through a pre-programmed sequence of movements.")
parser.add_argument('-c', '--config', default='config.py',
    help="Config file. Default is `config.py` (current directory).")
args = parser.parse_args()

cfg = config.Config(args.config)
vrepsim.set_path(cfg.vrep_path)
from pygesture.simulation import vrep

sim = vrepsim.VrepSimulation(cfg.vrep_port)
sim.start()

arm = vrepsim.MPL(sim.clientId)
ctrl = cfg.controller
time.sleep(1)

session = cfg.tac_sessions['4 active, 2 target']
for trial in session.trials[0:5]:
    target = {c.action: session.dist for c in trial}

    arm.position_controlled = True
    arm.command(target)
    time.sleep(2)

    arm.position_controlled = False
    for c in trial:
        for i in range(5):
            arm.command(ctrl.process((-1, c.label)))
            time.sleep(0.25)

        arm.command(ctrl.process((0, 0)))

    time.sleep(1)


arm.position_controlled = True
arm.command('no-contraction')

time.sleep(1)

sim.finish()
